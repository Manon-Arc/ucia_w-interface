{% extends "base.html" %}

{% block content %}
<video id="remoteVideo" autoplay></video>

<script>
    const remoteVideo = document.getElementById('remoteVideo');
    const configuration = { iceServers: [] };
    const rtcPeerConnection = new RTCPeerConnection(configuration);

    rtcPeerConnection.onicecandidate = (event) => {
        if (event.candidate) {
            // Send the ICE candidate to the WebRTC server on the Raspberry Pi
            sendData('ice-candidate', { 'ice-candidate': event.candidate });
        }
    };

    rtcPeerConnection.ontrack = (event) => {
        // Receive the video track from the WebRTC server on the Raspberry Pi
        remoteVideo.srcObject = event.streams[0];
    };

    async function startConnection() {
        console.log("Creating and sending offer");

        // Create an offer
        const offer = await rtcPeerConnection.createOffer();
        await rtcPeerConnection.setLocalDescription(new RTCSessionDescription({ type: 'offer', sdp: offer.sdp }));

        // Send the offer to the WebRTC server on the Raspberry Pi
        const answer = await sendData('offer', { 'sdp': rtcPeerConnection.localDescription.sdp, 'type': 'offer' });

        console.log("Received and setting answer");
        await rtcPeerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: answer.sdp }));
    }

    async function sendData(endpoint, data) {
        const response = await fetch(`http://rosa.local:8080/${endpoint}`, {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        });

        if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
        }

        return await response.json();
    }

    // Start the WebRTC connection when the page loads
    startConnection();
</script>
{% endblock %}